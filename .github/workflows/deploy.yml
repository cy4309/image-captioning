# name: Deploy Frontend & Backend

# on:
#   push:
#     branches:
#       - main # åªæœ‰æ¨ä¸Š main æ‰æœƒè§¸ç™¼éƒ¨ç½²
#   workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       # 1ï¸âƒ£ å–å¾—å°ˆæ¡ˆåŸå§‹ç¢¼
#       - name: â¬‡ï¸ Checkout repository
#         uses: actions/checkout@v4

#       # 2ï¸âƒ£ å®‰è£ Node.js ä»¥å»ºç½®å‰ç«¯
#       - name: ğŸŸ¢ Setup Node
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       # 3ï¸âƒ£ å‰ç«¯å®‰è£ä¾è³´ & Lint & Build
#       - name: ğŸ“¦ Install frontend dependencies
#         working-directory: ./frontend
#         run: npm install

#       - name: âœ… Run frontend lint
#         working-directory: ./frontend
#         run: npm run lint --if-present

#       - name: ğŸ› ï¸ Build frontend
#         working-directory: ./frontend
#         run: npm run build

#       # 4ï¸âƒ£ éƒ¨ç½² Vercelï¼ˆå‰ç«¯ï¼‰
#       - name: â–² Deploy to Vercel
#         run: |
#           npm install -g vercel
#           vercel deploy --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
#         env:
#           VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
#           VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

#       # 5ï¸âƒ£ é€šçŸ¥ Render éƒ¨ç½²å¾Œç«¯
#       - name: ğŸ”„ Trigger Render backend deploy
#         run: |
#           echo "Triggering Render deploy..."
#           curl -s -o /dev/null -w "%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"

name: Deploy Frontend & Backend

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout project
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node version + enable npm cache
      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      # 3ï¸âƒ£ Install frontend deps
      - name: ğŸ“¦ Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      # 4ï¸âƒ£ Run Vitest tests (no watch mode)
      - name: âœ… Run frontend tests
        working-directory: ./frontend
        run: npm run test -- --run

      # 5ï¸âƒ£ Run ESLint
      - name: ğŸ” Run frontend lint
        working-directory: ./frontend
        run: npm run lint --if-present

      # 6ï¸âƒ£ Build frontend (local build)
      - name: ğŸ› ï¸ Build frontend
        working-directory: ./frontend
        run: npm run build

      # 7ï¸âƒ£ Deploy to Vercel
      - name: â–² Deploy to Vercel
        working-directory: ./frontend
        run: |
          npm install -g vercel
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      # 8ï¸âƒ£ Trigger Render backend deploy
      - name: ğŸ”„ Trigger Render backend deploy
        if: success() # âœ… Only run if Vercel deploy succeeded
        run: |
          echo "Triggering Render deploy..."
          curl -s -o /dev/null -w "%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
